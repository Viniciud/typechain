!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("crypto")):"function"==typeof define&&define.amd?define(["exports","crypto"],t):t((e||self).typeCoin={},e.crypto)}(this,function(e,t){function n(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function o(e,t,o){return t&&n(e.prototype,t),o&&n(e,o),Object.defineProperty(e,"prototype",{writable:!1}),e}function i(){return i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},i.apply(this,arguments)}function r(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,s(e,t)}function s(e,t){return s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},s(e,t)}function a(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=new Array(t);n<t;n++)o[n]=e[n];return o}function c(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return(n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return a(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?a(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var o=0;return function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var l=0;function h(e){return"__private_"+l+++"_"+e}function u(e,t){if(!Object.prototype.hasOwnProperty.call(e,t))throw new TypeError("attempted to use private field on non-instance");return e}var d=function(e,t){this.header=void 0,this.payload=void 0,this.header=e,this.payload=t};function f(e){return t.createHash("sha256").update(JSON.stringify(e)).digest("hex")}function p(e){var t=e.hash,n=void 0===t?"":t,o=e.difficulty,i=e.prefix,r=(void 0===i?"0":i).repeat(void 0===o?4:o);return n.startsWith(r)}var y=new(0,require("elliptic").ec)("secp256k1"),g=/*#__PURE__*/h("fromAddress"),v=/*#__PURE__*/h("toAddress"),k=/*#__PURE__*/h("amount"),b=/*#__PURE__*/h("signature"),m=/*#__PURE__*/h("transactionHash"),B=/*#__PURE__*/function(){function e(e,t,n){Object.defineProperty(this,g,{writable:!0,value:void 0}),Object.defineProperty(this,v,{writable:!0,value:void 0}),Object.defineProperty(this,k,{writable:!0,value:void 0}),Object.defineProperty(this,b,{writable:!0,value:null}),Object.defineProperty(this,m,{writable:!0,value:void 0}),u(this,g)[g]=e,u(this,v)[v]=t,u(this,k)[k]=n,u(this,m)[m]=this.calculateHash()}var n=e.prototype;return n.calculateHash=function(){return t.createHash("sha256").update(u(this,g)[g]+u(this,v)[v]+u(this,k)[k]).digest("hex").toString()},n.signTransaction=function(e){if(e.getPublic("hex")!==u(this,g)[g])throw new Error("You cannot sign transaction for other wallets!");var t=this.calculateHash(),n=e.sign(t,"base64");u(this,b)[b]=n.toDER("hex")},n.isValid=function(){if(console.log("SIGNATURE ",u(this,b)[b]),console.log("FROMADDRESS ",u(this,g)[g]),"system"===u(this,g)[g])return!0;if(null===u(this,b)[b]&&"system"!==u(this,g)[g])return!1;if(null==u(this,b)[b]||0===u(this,b)[b].length)return!1;if(this.calculateHash()!==u(this,m)[m])return console.log("HASH diferente "),!1;var e=y.keyFromPublic(u(this,g)[g],"hex");return console.log("IS VALID ",e.verify(this.calculateHash(),u(this,b)[b])),e.verify(this.calculateHash(),u(this,b)[b])},o(e,[{key:"fromAddress",get:function(){return u(this,g)[g]}},{key:"toAddress",get:function(){return u(this,v)[v]}},{key:"amount",get:function(){return u(this,k)[k]}}]),e}(),O=/*#__PURE__*/h("chain"),w=/*#__PURE__*/function(e){function t(){return e.apply(this,arguments)||this}return r(t,e),t}(/*#__PURE__*/function(){function e(e){void 0===e&&(e=4),this.difficulty=void 0,Object.defineProperty(this,O,{writable:!0,value:[]}),this.pendingTransactions=[],this.miningReward=1,this.powPrefix="0",this.difficulty=e,u(this,O)[O].push(this.createGenesisBlock())}var t=e.prototype;return t.createGenesisBlock=function(){var e={sequency:0,timestamp:+new Date,data:[],previousHash:""};return new d({nonce:0,blockHash:f(JSON.stringify(e))},e)},t.lastBlockHash=function(){return console.log("LasBlockHash ",this.lastBlock.header.blockHash),this.lastBlock.header.blockHash},t.minePendingTransactions=function(e){var t=new B("system",e,this.miningReward);this.pendingTransactions.push(t);var n=this.createBlock(this.pendingTransactions),o=this.mineBlock(n);console.log("Block successfully mined!"),console.log("Bloco ",o.minedBlock);for(var i,r=c(n.data);!(i=r()).done;)console.log("Transactions ",i.value);this.sendBlock(o.minedBlock),this.pendingTransactions=[]},t.addTransaction=function(e){try{if(!e.fromAddress||!e.toAddress)throw new Error("Transaction must include from and to adress!");if(!e.isValid())throw console.log("addTransaction"),new Error("Cannot add invalid transaction to chain!");return console.log("ENTROU AQUI POR ALGUM MOTIVO"),this.pendingTransactions.push(e),Promise.resolve()}catch(e){return Promise.reject(e)}},t.getBalanceOfAddress=function(e){for(var t,n=0,o=c(u(this,O)[O]);!(t=o()).done;)for(var i,r=t.value,s=c(r.payload.data);!(i=s()).done;){var a=i.value;a.fromAddress===e&&(console.log("BLOCK ",r),console.log("TRANSACTIONS ",a),console.log("->"),n-=a.amount,console.log("------------------")),a.toAddress===e&&(console.log("BLOCK ",r),console.log("TRANSACTIONS ",a),console.log("->"),n+=a.amount,console.log("------------------"))}return n},t.createBlock=function(e){var t={sequency:this.lastBlock.payload.sequency+1,timestamp:+new Date,data:e,previousHash:this.lastBlockHash()};return console.log("Block #"+t.sequency+" created: "+JSON.stringify(t)),t},t.mineBlock=function(e){for(var t=0,n=+new Date;;){var o=f(JSON.stringify(e));if(p({hash:f(o+t),difficulty:this.difficulty,prefix:this.powPrefix})){var r=+new Date,s=o.slice(0,12);return console.log("Block #"+e.sequency+" mined in "+(r-n)/1e3+"s. Hash "+s+" ("+t+" attempts)"),{minedBlock:{payload:i({},e),header:{nonce:t,blockHash:o}}}}t++}},t.checkBlockTransactions=function(e){for(var t,n=c(e.payload.data);!(t=n()).done;)if(!t.value.isValid())return!1;return!0},t.checkBlock=function(e){return this.checkBlockTransactions(e)?(console.log("BLOCK checkBLock ",e),console.log("BLOCK last  ",this.lastBlock),e.payload.previousHash!==this.lastBlockHash()?(console.error("Block #"+e.payload.sequency+" it's "+this.lastBlockHash().slice(0,12)+" indeed "+e.payload.previousHash.slice(0,12)),!1):!!p({hash:f(f(JSON.stringify(e.payload))+e.header.nonce),difficulty:this.difficulty,prefix:this.powPrefix})||(console.error("Block #"+e.payload.sequency+" it's invalid! Nonce "+e.header.nonce+" it's invalid and can't be checked!"),!1)):(console.log("checkBlock"),!1)},t.sendBlock=function(e){return this.checkBlock(e)&&(u(this,O)[O].push(e),console.log("Block #"+e.payload.sequency+" has been added into blockchain: "+JSON.stringify(e,null,2))),console.log("FULL CHAIN ",u(this,O)[O]),u(this,O)[O]},o(e,[{key:"chain",get:function(){return u(this,O)[O]}},{key:"lastBlock",get:function(){return 1!==this.chain.length?this.chain[this.chain.length-2]:this.chain[0]}}]),e}()),A=/*#__PURE__*/function(e){function t(){return e.apply(this,arguments)||this}return r(t,e),t}(d);e.TypecoinBlock=A,e.default=w});
