var t=require("crypto");function e(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function n(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),Object.defineProperty(t,"prototype",{writable:!1}),t}function o(){return o=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o])}return t},o.apply(this,arguments)}function r(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,i(t,e)}function i(t,e){return i=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},i(t,e)}function s(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,o=new Array(e);n<e;n++)o[n]=t[n];return o}function a(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(n)return(n=n.call(t)).next.bind(n);if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return s(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?s(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var o=0;return function(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c=0;function l(t){return"__private_"+c+++"_"+t}function h(t,e){if(!Object.prototype.hasOwnProperty.call(t,e))throw new TypeError("attempted to use private field on non-instance");return t}var u=function(t,e){this.header=void 0,this.payload=void 0,this.header=t,this.payload=e};function d(e){return t.createHash("sha256").update(JSON.stringify(e)).digest("hex")}function f(t){var e=t.hash,n=void 0===e?"":e,o=t.difficulty,r=t.prefix,i=(void 0===r?"0":r).repeat(void 0===o?4:o);return n.startsWith(i)}var p=new(0,require("elliptic").ec)("secp256k1"),y=/*#__PURE__*/l("fromAddress"),v=/*#__PURE__*/l("toAddress"),g=/*#__PURE__*/l("amount"),k=/*#__PURE__*/l("signature"),b=/*#__PURE__*/l("transactionHash"),m=/*#__PURE__*/function(){function e(t,e,n){Object.defineProperty(this,y,{writable:!0,value:void 0}),Object.defineProperty(this,v,{writable:!0,value:void 0}),Object.defineProperty(this,g,{writable:!0,value:void 0}),Object.defineProperty(this,k,{writable:!0,value:null}),Object.defineProperty(this,b,{writable:!0,value:void 0}),h(this,y)[y]=t,h(this,v)[v]=e,h(this,g)[g]=n,h(this,b)[b]=this.calculateHash()}var o=e.prototype;return o.calculateHash=function(){return t.createHash("sha256").update(h(this,y)[y]+h(this,v)[v]+h(this,g)[g]).digest("hex").toString()},o.signTransaction=function(t){if(t.getPublic("hex")!==h(this,y)[y])throw new Error("You cannot sign transaction for other wallets!");var e=this.calculateHash(),n=t.sign(e,"base64");h(this,k)[k]=n.toDER("hex")},o.isValid=function(){if(console.log("SIGNATURE ",h(this,k)[k]),console.log("FROMADDRESS ",h(this,y)[y]),"system"===h(this,y)[y])return!0;if(null===h(this,k)[k]&&"system"!==h(this,y)[y])return!1;if(null==h(this,k)[k]||0===h(this,k)[k].length)return!1;if(this.calculateHash()!==h(this,b)[b])return console.log("HASH diferente "),!1;var t=p.keyFromPublic(h(this,y)[y],"hex");return console.log("IS VALID ",t.verify(this.calculateHash(),h(this,k)[k])),t.verify(this.calculateHash(),h(this,k)[k])},n(e,[{key:"fromAddress",get:function(){return h(this,y)[y]}},{key:"toAddress",get:function(){return h(this,v)[v]}},{key:"amount",get:function(){return h(this,g)[g]}}]),e}(),B=/*#__PURE__*/l("chain"),O=/*#__PURE__*/function(t){function e(){return t.apply(this,arguments)||this}return r(e,t),e}(/*#__PURE__*/function(){function t(t){void 0===t&&(t=4),this.difficulty=void 0,Object.defineProperty(this,B,{writable:!0,value:[]}),this.pendingTransactions=[],this.miningReward=1,this.powPrefix="0",this.difficulty=t,h(this,B)[B].push(this.createGenesisBlock())}var e=t.prototype;return e.createGenesisBlock=function(){var t={sequency:0,timestamp:+new Date,data:[],previousHash:""};return new u({nonce:0,blockHash:d(JSON.stringify(t))},t)},e.lastBlockHash=function(){return console.log("LasBlockHash ",this.lastBlock.header.blockHash),this.lastBlock.header.blockHash},e.minePendingTransactions=function(t){var e=new m("system",t,this.miningReward);this.pendingTransactions.push(e);var n=this.createBlock(this.pendingTransactions),o=this.mineBlock(n);console.log("Block successfully mined!"),console.log("Bloco ",o.minedBlock);for(var r,i=a(n.data);!(r=i()).done;)console.log("Transactions ",r.value);this.sendBlock(o.minedBlock),this.pendingTransactions=[]},e.addTransaction=function(t){try{if(!t.fromAddress||!t.toAddress)throw new Error("Transaction must include from and to adress!");if(!t.isValid())throw console.log("addTransaction"),new Error("Cannot add invalid transaction to chain!");return console.log("ENTROU AQUI POR ALGUM MOTIVO"),this.pendingTransactions.push(t),Promise.resolve()}catch(t){return Promise.reject(t)}},e.getBalanceOfAddress=function(t){for(var e,n=0,o=a(h(this,B)[B]);!(e=o()).done;)for(var r,i=e.value,s=a(i.payload.data);!(r=s()).done;){var c=r.value;c.fromAddress===t&&(console.log("BLOCK ",i),console.log("TRANSACTIONS ",c),console.log("->"),n-=c.amount,console.log("------------------")),c.toAddress===t&&(console.log("BLOCK ",i),console.log("TRANSACTIONS ",c),console.log("->"),n+=c.amount,console.log("------------------"))}return n},e.createBlock=function(t){var e={sequency:this.lastBlock.payload.sequency+1,timestamp:+new Date,data:t,previousHash:this.lastBlockHash()};return console.log("Block #"+e.sequency+" created: "+JSON.stringify(e)),e},e.mineBlock=function(t){for(var e=0,n=+new Date;;){var r=d(JSON.stringify(t));if(f({hash:d(r+e),difficulty:this.difficulty,prefix:this.powPrefix})){var i=+new Date,s=r.slice(0,12);return console.log("Block #"+t.sequency+" mined in "+(i-n)/1e3+"s. Hash "+s+" ("+e+" attempts)"),{minedBlock:{payload:o({},t),header:{nonce:e,blockHash:r}}}}e++}},e.checkBlockTransactions=function(t){for(var e,n=a(t.payload.data);!(e=n()).done;)if(!e.value.isValid())return!1;return!0},e.checkBlock=function(t){return this.checkBlockTransactions(t)?(console.log("BLOCK checkBLock ",t),console.log("BLOCK last  ",this.lastBlock),t.payload.previousHash!==this.lastBlockHash()?(console.error("Block #"+t.payload.sequency+" it's "+this.lastBlockHash().slice(0,12)+" indeed "+t.payload.previousHash.slice(0,12)),!1):!!f({hash:d(d(JSON.stringify(t.payload))+t.header.nonce),difficulty:this.difficulty,prefix:this.powPrefix})||(console.error("Block #"+t.payload.sequency+" it's invalid! Nonce "+t.header.nonce+" it's invalid and can't be checked!"),!1)):(console.log("checkBlock"),!1)},e.sendBlock=function(t){return this.checkBlock(t)&&(h(this,B)[B].push(t),console.log("Block #"+t.payload.sequency+" has been added into blockchain: "+JSON.stringify(t,null,2))),console.log("FULL CHAIN ",h(this,B)[B]),h(this,B)[B]},n(t,[{key:"chain",get:function(){return h(this,B)[B]}},{key:"lastBlock",get:function(){return 1!==this.chain.length?this.chain[this.chain.length-2]:this.chain[0]}}]),t}());exports.TypecoinBlock=/*#__PURE__*/function(t){function e(){return t.apply(this,arguments)||this}return r(e,t),e}(u),exports.default=O;
